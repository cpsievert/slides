---
title: "Hello woRld"
subtitle: "Follow along at <http://cpsievert.github.io/slides/intro>"
author: "Carson Sievert"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    transition: default
    widescreen: true
css:
  styles.css
---

```{r setup, include = FALSE}
library(methods)
knitr::opts_chunk$set(
  message = FALSE,
  cache = FALSE,
  fig.height = 2,
  fig.width = 5
)
```

# With your neighbor, list some things R _is_ and _does_

### R is ...
### R does ...

## R is ...

> - __Free__ to use
> - __Extensible__
    * Over 7300 user contributed add-on packages currently on CRAN!
> - __Powerful__
    * With the right tools, get more work done, faster.
> - __Flexible__
    * Not a question of _can_, but _how_.
> - __Frustrating__
    * Flexibility comes at a cost (easy to shoot yourself in the foot!).

## R does ...

* __Graphics, statistics, machine learning, etc.__
* __Data acquisition, munging, management__
* __Literate programming (dynamic reports)__
* __Web applications__

(This roughly serves as our outline)

```{r, eval = FALSE, echo = FALSE}
# devtools::install_github("metacran/crandb")
# pkgs <- crandb::list_packages(limit = 999999)
# length(pkgs)
# [1] 7330
```

## Obligatory economics example

US economic time series data bundled with __ggplot2__:

```{r}
data(economics, package = "ggplot2")
str(economics)
```

> - `str()` is quite possibly my favorite `R` function. It shows you the "structure" of _any_ R object (and _everything_ in R is an object!!!)

## Getting Help

Prefix any function with `?` to read more about it.

```{r, eval = FALSE}
?str
```

Data sets distributed with packages should also be documented

```{r, eval = FALSE}
?economics
```

__Your Turn__: Read the variable descriptions for `economics`. Can you think of a interesting/informative function of these variable(s)?

## Hello ggplot2

```{r, fig.height = 3, fig.width = 10}
library(ggplot2)
p <- ggplot(economics, aes(date, unemploy / pop)) + 
  geom_line()
p
```

## Hello Linear/Additive Models!

```{r, fig.show = 'hold'}
p
p + geom_smooth(method = "lm", se = F)
p + geom_smooth(method = "loess", se = F)
p + geom_smooth(method = "gam", formula = y ~ s(x, bs = "cr"), se = F)
```

## How did ggplot2 add that smoother?

```{r}
m <- lm((unemploy / pop) ~ date, data = economics)
str(m)
```

---

```{r, fig.height = 3, fig.width = 10}
economics$yhat <- m$fitted.values
ggplot(economics) + 
  geom_line(aes(date, unemploy / pop)) +
  geom_line(aes(date, yhat), color = "blue")
```

> - __Your Turn__: Make the loess smoother plot without `geom_smooth()` (hint: convert `date` to a numeric vector with `as.numeric()` and use `loess()`).

## Time Series Analysis

<ul class="build">

`R` has a ton of support for time series analysis (see the [Task View](https://cran.r-project.org/web/views/TimeSeries.html)). 

To create a time series (aka `"ts"`) object, use the `ts()` function

```{r}
r <- ts(economics$unemploy / economics$pop)
str(r)
class(r)
ar1 <- arima(r, order = c(1, 0, 0))
class(ar1)
```
</ul>

---

```{r}
str(predict(ar1))
```

> - From `?predict`:
    * `predict()` is a _generic function_ for predictions from the results of various model fitting functions. The function invokes particular _methods_ which depend on the class of the first argument.

> - Since `class(ar1)` is `"Arima"`, `predict(ar1)` calls `predict.Arima()`.

> - Base R comes with a bunch of prediction methods, and add-on packages can easily add new prediction methods for new classes.

---

```{r}
methods(predict)
```

---

`summary()` is another useful generic function. Turns out `summary.Arima()` doesn't exist in base `R`, but Rob and George provide one for us :)

```{r}
library(forecast)
summary(ar1)
```

---

```{r}
methods(summary)
```

---

**Your Turn**: Have a look over `?predict` and `?predict.Arima`. Forecast 100 steps ahead using the `ar1` model.

<ul class="build">
```{r}
f <- predict(ar1, n.ahead = 100)
str(f)
```

In order to plot our forecast, we'll need the forecasted dates.

```{r}
head(economics$date, 4)
```

```{r}
dates <- seq(max(economics$date), length.out = 100, by = "1 month")
df <- data.frame(f, date = dates)
```

</ul>


## Plotting forecasts

```{r, fig.height = 3, fig.width = 10}
ggplot() + 
  geom_line(data = economics, aes(date, unemploy / pop)) +
  geom_line(data = df, aes(date, pred), color = "blue") +
  geom_ribbon(data = df, aes(date, ymax = pred + se, ymin = pred - se), 
              fill = "grey", alpha = 0.4)
```

## Interactive and web-based!

```{r, cache = FALSE}
library(plotly)
ggplotly()
```

## Reshaping data

<div align="center">
  <img src="reshape.png" width="900" height="500">
</div>

---

```{r, echo = FALSE}
data(economics)
```


```{r}
head(economics)
```

<ul class="build">
```{r}
library(tidyr)
e <- gather(economics, variable, value, -date)
head(e)
```
</ul>

---

```{r, fig.height = 5.5, fig.width = 10}
ggplot(e, aes(date, value)) + geom_line() +
  facet_wrap(~ variable, scales = "free_y")
```

## Pure functional programming


Pure functions _modify_ a central object-type (e.g., input a data frame and output another data frame)

__Your turn__: Have we encountered any 'pure' function(s)? Can you think of any other pure functions?

## Pure functions in base R

<ul class="build">
```{r}
subset(
  transform(
    economics,
    year = format(date, "%Y")
  ),
  year == 2000
)
```
</ul>

---

<div align = "center">
  <img src="pure.jpeg" width="900" height="300" />
</div>

---

<ul class="build">
__magrittr's__ `%>%` operator makes it much easier to read a sequence of pure manipulations

```{r, eval = FALSE}
library(magrittr)
economics %>%
  transform(year = format(date, "%Y")) %>%
  subset(year == 2000)
```

```{r, eval = FALSE}
# in general, this:
f(g(x), y) 
# equal this
x %>% g() %>% f(y)
```
</ul>

## dplyr: A consistent grammar of data manipulation

```{r}
library(dplyr)
economics %>%
  mutate(year = format(date, "%Y")) %>%
  filter(year == 2000)
```

## Split-apply-combine

<div align="center">
<img src="http://inundata.org/R_talks/meetup/images/splitapply.png" width="750" height="500">
</div>

Image by Karthik Ram -> <http://inundata.org/R_talks/meetup/images/splitapply.png>

## Split-apply-combine in dplyr

```{r}
economics %>%
  mutate(year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(mpce = mean(pce))
```

## Your Turn

Find the average annual personal savings rate (`psavert`)

<ul class="build">
```{r}
economics %>%
  mutate(year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(mpce = mean(psavert))
```
</ul>


## A new example: babynames

```{r}
library(babynames)
head(babynames)
dim(babynames)
```

## dplyr loves databases

```{r, eval = FALSE}
db <- src_sqlite("intro/babynames.sqlite3", create = TRUE)
copy_to(db, babynames, temporary = FALSE)
```

```{r, echo = FALSE, cache = FALSE}
db <- src_sqlite("babynames.sqlite3")
```

```{r}
db
tbl(db, "babynames")
```

## Send computation to the data

<ul class="build">
```{r}
h <- db %>% 
  tbl("babynames") %>%
  filter(name == "Hilary")
```

```{r}
class(h)
h$query
```
</ul>

---


<ul class="build">
```{r}
# execute SQL command and bring into R
hc <- collect(h)
class(hc)
```

```{r}
hc
```
</ul>

---

```{r, fig.height = 3, fig.width = 10, cache = FALSE, warning = FALSE}
plot_ly(hc, x = year, y = prop, color = sex, colors = c("blue", "hotpink"))
```


---

<!-- TODO

plotly + dplyr

-->

---

```{r, eval = FALSE}
library(shiny)
library(babynames)
library(ggplot2)
ui <- bootstrapPage(
  selectizeInput(
    inputId = 'name', 
    label = 'Enter a name', 
    choices = unique(babynames$name),
    selected = "Hadley",
    multiple = TRUE
  ),
  plotOutput('plot')
)
server <- function(input, output) {
  output$plot <- renderPlot({ 
    dat <- subset(babynames, name %in% input$name)
    ggplot(dat, aes(year, prop, colour = sex)) + 
      geom_line() + facet_wrap(~ name)
  })
}
runApp(
  shinyApp(ui, server)
)
```

## Speed up version


```{r, eval = FALSE}
saveRDS(unique(babynames$name), file = "babynames_fast/names.rds")
DBI::dbSendQuery(db$con, 'CREATE INDEX nms ON babynames(name)')
```


## Data Acquisition
